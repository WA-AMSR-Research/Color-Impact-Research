<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Wakaba Aihara's AMSR -Matching Game</title>
    <link href="common.css" rel="stylesheet">
</head>

<body>
    <div id="gameTitle">
        <h1>Matching Cards</h1>
        <h2>&nbsp;</h2>
    </div>
    <div id="gamePanel">
        <div id="gameFrame3">
		        <div id="panel"></div>
	      </div>
    </div>
    <div id="gameTimer">
        <h2 id="elapsedTime">&nbsp;</h2>
    </div>
    <div id="gameModal">
        <div class="overlay" >
            <div class="popup">
                <h2>Congratulations!</h2>
                <h3>You have matched all the cards <span id="elapsedTimeInModal">&nbsp;</span></h3>
    	          <h3>Click on "Continue" to move onto the next test.</h3>
                <h3><button id="continue" onclick="goNextPage()">Continue</button></h3>
            </div>
        </div>
    </div>

    <!-- javascripts -->
    <script src="lib/jquery-3.6.0.js"></script>
    <script src="lib/jquery.rwdImageMaps.min.js"></script>
    <script src="common.js"></script>

    <script>
    var backTimer;
    var flgFirst = true;
    var cardFirst;
    var countUnit = 0;

    cardGame_shuffle = (arr) => {
      var n = arr.length;
      var temp, i;
      while (n) {
        i = Math.floor(Math.random() * n--);
        temp = arr[n];
        arr[n] = arr[i];
        arr[i] = temp;
      }
      return arr;
    }

    //when clicked
    function cardGame_turn(e) {
      var div = e.target;
      if (backTimer) return;

      // show number when a card is on the back is clicked
      if (div.innerHTML == '') {
        div.className = 'card';
        div.innerHTML = div.number;
      } else {
        // return if the number is already shown
        return;
      }

      if (flgFirst) {
        cardFirst = div;
        flgFirst = false;
    } else {
        if (cardFirst.number == div.number) {
            countUnit++;

            backTimer = setTimeout(function () {
              div.className = 'card finish';
              cardFirst.className = 'card finish';
              backTimer = NaN;

              if (countUnit == 6) {
                stopGameTimer();
                 endGame();
              }
            }, 500)

        // if the two cards DO NOT match
        } else {
            // turn the cards back
            backTimer = setTimeout(function () {
                div.className = 'card back';
                div.innerHTML = '';
                cardFirst.className = 'card back';
                cardFirst.innerHTML = '';
                cardFirst = null;
                backTimer = NaN;
            }, 500);
        }
        flgFirst = true;
      }
    }

    initCardGame = () => {
      var arr = [];
      for (var i = 0; i < 6; i++) {
        arr.push(i);
        arr.push(i);
      }
      cardGame_shuffle(arr);

      var panel = document.getElementById('panel');

      for (i = 0; i < 12; i++) {
        var div = document.createElement('div');
        div.className = 'card back';
        div.index = i;
        div.number = arr[i];
        div.innerHTML = '';
        div.onclick = cardGame_turn;
        panel.appendChild(div);
      }
    }

    /* Game Flow */
    initGame = () => {
      initCardGame();
    }

    startGame = () => {
      setPageBgColor();
      initGame();
      startGameTimer();
    }

    endGame = () => {
      stopGameTimer();
      saveElapsedTime("elapsedTimeCardGame");
      showModal();
    }

    goNextPage = ( ) => {
      window.location.href = 'spot_difference.html';
    }

    /* Game Entry Point */
    startGame();

    </script>
</body>

</html>
